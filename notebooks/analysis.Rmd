---
title: "R Notebook"
output: html_notebook
---

### Import required data and libraries

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(tidyverse)
library(latex2exp)
library(scales)
library(extrafont)
library(viridis)
library(ggridges)
library(forcats)
# set fonts
loadfonts(device = "pdf")
# font_import()
# link www.fontsquirrel.com/fonts/latin-modern-roman

# execute once to add fonts:
# font_import(pattern = "lmroman*")
# theme(legend.position = "top", text=element_text(size=14, family="LM Roman 10"))

# set ggplot global theme
theme_set(theme_bw())

# load pre-processed data
load(file="Data/description.RData")
load(file="Data/results.RData")
```

### How much of the used dependencies are explicitly declared by the clients?

```{r}
nb_direct_and_transitive_deps <- 
  results %>%
  group_by(Artifact, Type) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  ungroup() %>%
  complete(Artifact, Type, fill = list(n = 0, freq = 0))

# summary statistics of direct and transitive dependencies
direct_deps <- nb_direct_and_transitive_deps %>% filter(Type == "direct")
transitive_deps <- nb_direct_and_transitive_deps  %>% filter(Type == "transitive")
summary(direct_deps$n)
summary(transitive_deps$n)

print("percentage of direct deps:")
(sum(transitive_deps$n) * 100) / (sum(direct_deps$n) + sum(transitive_deps$n))
print("percentage of transitive deps:")
(sum(direct_deps$n) * 100) / (sum(direct_deps$n) + sum(transitive_deps$n))

# save the data objects
save(nb_direct_and_transitive_deps, file = "Data/nb_direct_and_transitive_deps.RData")
load(file = "Data/nb_direct_and_transitive_deps.RData")

```

Violinplot with the distribution of direct and transitive dependencies

```{r}
# plot boxplot the distribution of direct and transitive dependencies
nb_direct_and_transitive_deps$Type <- ifelse(nb_direct_and_transitive_deps$Type == "direct", "Direct", "Transitive")
means <- aggregate(n ~  Type, nb_direct_and_transitive_deps, mean)
means$n <- round(means$n, 2)
nb_direct_and_transitive_deps_boxplot <- 
  nb_direct_and_transitive_deps %>% 
  ggplot(aes(Type, n)) +
  geom_violin(trim = FALSE, aes(fill = Type)) +
  geom_boxplot(width = 0.1) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^ .x))
  ) +
  geom_point(data = means,
             aes(x=Type, y=n),
             colour="black",
                shape=18, size=6, show.legend = FALSE)+
  geom_point(data = means,
             aes(x=Type, y=n),
             colour="green", 
                shape=18, size=4, show.legend = FALSE)+
  geom_text(data = means, aes(label = n, y = n)) +
  scale_fill_viridis(discrete = TRUE, option = "D", alpha = 0.75) +
  ylab(TeX("#Dependencies")) +
  xlab("") +
  theme(legend.position = "none",
        text = element_text(size = 16, family = "LM Roman 10")) +
  coord_flip()

ggsave(filename = "Figures/direct-and-transitive-boxplot.pdf", plot = nb_direct_and_transitive_deps_boxplot,
       height = 3, width = 7,  units = c("in"), device = "pdf")
```

Barplot with the distribution of direct and transitive dependencies

```{r}
# to order the bars: obtain a vector of the categories, ordered by your quantity of interest
dependency_levels <- names(sort(tapply(nb_direct_and_transitive_deps$n, nb_direct_and_transitive_deps$Type, sum)))
  
nb_direct_and_transitive_deps_bars <- 
  ggplot(nb_direct_and_transitive_deps, aes(reorder(Artifact, percent), percent)) +
  geom_bar(stat = "identity",width = 1, aes(fill = factor(Type, levels = dependency_levels))) +
  xlab("Libraries") +
  ylab("#Dependencies") +
  scale_fill_viridis(discrete = TRUE) +
  # scale_y_log10(
  #   breaks = scales::trans_breaks("log10", function(x) 10 ^ x),
  #   labels = scales::trans_format("log10", scales::math_format(10 ^ .x))
  # ) +
  theme(axis.text.x = element_blank(),  axis.ticks.x = element_blank(), axis.line = element_line(colour = "black")) +
  scale_fill_discrete(name = "Type", labels = c("Direct", "Transitive")) +
  theme(legend.position = "top", text=element_text(size=16, family="LM Roman 10"))

ggsave(filename = "Figures/direct-and-transitive-bars.pdf", plot = nb_direct_and_transitive_deps_bars,
       height = 3, width = 20,  units = c("in"), device = "pdf")
```

Geom_area with the distribution of direct and transitive dependencies

```{r}
# Calculate the mean of each group
# mu <- ddply(nb_direct_and_transitive_deps, "Type", summarise, grp.mean=mean(percent))
nb_direct_and_transitive_deps$Artifact <- as.numeric(nb_direct_and_transitive_deps$Artifact)

nb_direct_and_transitive_deps_area <-
  nb_direct_and_transitive_deps %>%
  ggplot(aes(
    x = Artifact,
    y = percent,
    fill = Type
  )) +
  geom_area(alpha = 1, position = "fill") +
  ylab("%Dependencies") +
  xlab("Libraries") +
  xlim(0, 10000) +
  scale_y_continuous(labels = scales::percent) +
  scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "top",
        text = element_text(size = 16, family = "LM Roman 10"))

ggsave(filename = "Figures/direct-and-transitive-area.pdf", plot = nb_direct_and_transitive_deps_area,
       height = 3, width = 7,  units = c("in"), device = "pdf")
```


### How frequent is the occurrence of bloated dependencies in the Maven ecosystem?

Barplot with the Types of Usages

```{r}
results_bloat <- results %>% 
  # filter(Scope == "compile", Optional == "false", Type == "direct") %>% 
  mutate(TypeUsage = ifelse(UsedDeclared == "true", "UsedDeclared", ifelse(UsedUndeclared == "true", "UsedUndeclared", ifelse(BloatedDeclared == "true", "BloatedDeclared", "BloatedUndeclared"))))

results_bloat_barplot <- results_bloat %>%
  filter(Scope %in% c("compile", "test", "runtime", "provided")) %>% 
  group_by(TypeUsage, Scope) %>%
  dplyr::summarise(Count = n()) %>% 
  ggplot(aes(x = Scope, y = Count, fill = TypeUsage)) +
  geom_bar(stat="identity") +
  scale_fill_viridis(discrete = TRUE) +
  theme(legend.position = "top", legend.title = element_blank(), text = element_text(size = 16, family = "LM Roman 10"))

# percentage of each scope
results_bloat %>% dplyr::group_by(Scope) %>% dplyr::summarise(n = n()) %>% mutate (percent = n / sum(n) * 100) %>% ungroup()

ggsave(filename = "Figures/results_bloat_barplot.pdf", plot = results_bloat_barplot ,
       height = 4, width = 7,  units = c("in"), device = "pdf")
```

Do the most popular libraries have more dependencies?

```{r}
data_usages <- data %>%
  mutate(Artifact = paste(paste(GroupId, ArtifactId, sep = ":"), Version, sep = ":")) %>%
  select(Artifact, DUsages)

results %>% dplyr::count(Artifact, Type)

bloat_ratio <- results_bloat %>% 
  dplyr::group_by(Artifact, TypeUsage) %>%
  dplyr::summarise (n = n()) %>%
  dplyr::mutate(freq = n / sum(n)) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Artifact) %>% 
  dplyr::mutate(TotalDeps= sum(n))

bloat_ratio <- bloat_ratio %>% filter(TypeUsage == "BloatedDeclared" | TypeUsage == "BloatedUndeclared" )

bloat_popularity <- inner_join(bloat_ratio, data_usages)

library(corrplot)
M <- cor(bloat_popularity$freq, bloat_popularity$DUsages)


lm_eqn <- function(bloat_popularitTotalDeps){
    m <- lm(TotalDeps ~ freq, bloat_popularitTotalDeps);
    eq <- substitute(italic(TotalDeps) == a + b %.% italic(freq)*","~~italic(r)^2~"="~r2, 
         list(a = format(unname(coef(m)[1]), digits = 2),
              b = format(unname(coef(m)[2]), digits = 2),
             r2 = format(summary(m)$r.squared, digits = 3)))
    as.character(as.expression(eq));
}

# ----------------------------------------------------------------------------
# correlation between bloated and number of dependencies
# ----------------------------------------------------------------------------
bloat_popularity %>% ggplot(aes(x = freq, y = TotalDeps)) +
  geom_smooth(method='lm', formula=y~x) +
  scale_fill_viridis(discrete = TRUE) +
  geom_point(alpha = 0.1) + 
  coord_cartesian( xlim = c(0, 1), ylim = c(0, 500)) +
  # add correlation labels
  # geom_text(x = 0.3, y = 300, label = lm_eqn(bloat_popularity), parse = TRUE) +
  labs(x="%Bloated dependencies", y="#Dependencies") +
  scale_x_continuous(labels = scales::percent) +
  theme(legend.position = "top", text = element_text(size = 16, family = "LM Roman 10"))

# geom_hex chart
bloat_deps_hex <-bloat_popularity %>% ggplot(aes(x = freq, y = TotalDeps)) +
  geom_hex() +
   scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^ .x))
  ) +
  scale_fill_viridis() +
  labs(x="%Bloated dependencies", y="#Dependencies") +
  scale_x_continuous(labels = scales::percent) +
  theme(legend.position = "right", text = element_text(size = 16, family = "LM Roman 10"))

ggsave(filename = "Figures/bloat_deps_hex.pdf", plot = bloat_deps_hex,
       height = 3, width = 5,  units = c("in"), device = "pdf")

# ----------------------------------------------------------------------------
# correlation between bloated and direct usages
# ----------------------------------------------------------------------------
bloat_popularity %>% ggplot(aes(x = freq, y = DUsages)) +
  geom_smooth(method='lm', formula=y~x) +
  scale_fill_viridis(discrete = TRUE) +
  # add correlation labels
  # geom_text(x = 0.3, y = 300, label = lm_eqn(bloat_popularity), parse = TRUE) +
  labs(x="%Bloated dependencies", y="#Usages") +
  scale_x_continuous(labels = scales::percent) +
  theme(legend.position = "top", text = element_text(size = 16, family = "LM Roman 10"))

# geom_hex chart
bloat_usages_hex <- bloat_popularity %>% ggplot(aes(x = freq, y = DUsages)) +
  geom_hex() +
   scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x) 10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^ .x))
  ) +
  scale_fill_viridis() +
  labs(x="%Bloated dependencies", y="#Usages") +
  scale_x_continuous(labels = scales::percent) +
  theme(legend.position = "right", text = element_text(size = 16, family = "LM Roman 10"))

ggsave(filename = "Figures/bloat_usages_hex.pdf", plot = bloat_usages_hex,
       height = 3, width = 5,  units = c("in"), device = "pdf")

# ----------------------------------------------------------------------------
# ridgeline deep of the tree and percentage of bloated deps
# ----------------------------------------------------------------------------
bloat_treedeep<- inner_join(bloat_ratio, description, by = "Artifact") %>% dplyr::select(Artifact, TypeUsage, freq, HeightOriginalDT)
 
bloat_treedeep$HeightOriginalDT <- as.factor(bloat_treedeep$HeightOriginalDT)

bloat_treedeep_ridges <- bloat_treedeep %>% 
  filter(is.na(HeightOriginalDT) == F) %>% 
  ggplot(aes(x = freq, y = HeightOriginalDT, fill = ..x..)) +
  geom_density_ridges_gradient(scale = 3, rel_min_height = 0.01) +
  scale_fill_viridis(name = "freq", option = "C") +
  scale_x_continuous(labels = scales::percent) +
  theme(legend.position = "right", text = element_text(size = 16, family = "LM Roman 10")) +
  labs(x=NULL, y="Height of the DT") +
  facet_wrap(~TypeUsage)

ggsave(filename = "Figures/bloat_treedeep_ridges.pdf", plot = bloat_treedeep_ridges,
       height = 4, width = 7,  units = c("in"), device = "pdf") 

```


### How much dependency conflicts are due to bloated dependencies?

```{r}


results %>% gro
```





### Comparison between the height of the original vs debloated dependency tree

```{r}
description$HeightOriginalDT <-  as.numeric(description$HeightOriginalDT)
description$HeightDebloatedDT <-  as.numeric(description$HeightDebloatedDT)

description %>% ggplot(aes(HeightOriginalDT)) +
  geom_histogram()

description %>% ggplot(aes(HeightDebloatedDT)) +
  geom_histogram()

metrics %>%
  filter(is.na(isPassive) == F) %>%
  mutate(Type = ifelse(isPassive == "true", "passive", "active")) %>% 
  # filter(Type == "passive") %>% 
  # filter(validityPeriod > 0) %>% 
  ggplot(aes(Type, lifespan)) +
  geom_violin(trim = FALSE, fill = "#CCCCCC") +
  geom_boxplot(width = 0.1) +
  scale_y_log10(
    breaks = scales::trans_breaks("log10", function(x)
      10 ^ x),
    labels = scales::trans_format("log10", scales::math_format(10 ^ .x))
  ) +
  coord_flip() +
  theme(legend.position = "none") +
  xlab(NULL) +
  ylab(TeX("lifespan (log_{10} scale)"))
  
```




```{r}
# library
library(ggridges)
library(ggplot2)
library(dplyr)
library(tidyr)
library(forcats)

# Load dataset from github
data <- read.table("https://raw.githubusercontent.com/zonination/perceptions/master/probly.csv", header=TRUE, sep=",")
data <- data %>% 
  gather(key="text", value="value") %>%
  mutate(text = gsub("\\.", " ",text)) %>%
  mutate(value = round(as.numeric(value),0)) %>%
  filter(text %in% c("Almost Certainly","Very Good Chance","We Believe","Likely","About Even", "Little Chance", "Chances Are Slight", "Almost No Chance"))

# Plot
data %>%
  mutate(text = fct_reorder(text, value)) %>%
  ggplot( aes(y=text, x=value,  fill=text)) +
    geom_density_ridges(alpha=0.6, stat="binline", bins=20) +
    theme_ridges() +
    theme(
      legend.position="none",
      panel.spacing = unit(0.1, "lines"),
      strip.text.x = element_text(size = 8)
    ) +
    xlab("") +
    ylab("Assigned Probability (%)")
```




```{r}
# data preparation library(ggplot2)
col <- c("red", "pink", "orange", "brown")
freq <- c(101, 68, 34, 18)

tmp %>% group_by(Artifact,Type) %>% 
  summarise(count=n())
## create data frame
colour.df <- data.frame(col, freq)
colour.df

## calculate percentage 
colour.df$percentage = colour.df$freq / sum(colour.df$freq)* 100
colour.df = colour.df[rev(order(colour.df$percentage)), ]
colour.df$ymax = cumsum(colour.df$percentage)
colour.df$ymin = c(0, head(colour.df$ymax, n = -1))
colour.df

library(ggrepel)
colour.df %>% ggplot(aes(fill = col, ymax = ymax, ymin = ymin, xmax = 100, xmin = 80)) +
    geom_rect(colour = "black") +
    coord_polar(theta = "y") + 
    xlim(c(0, 100)) +
    geom_label_repel(aes(label = paste(round(percentage,2),"%"), x = 100, y = (ymin + ymax)/2),inherit.aes = F, show.legend = F, size = 5)+
    theme(legend.title = element_text(colour = "black", size = 16, face = "bold"), 
        legend.text = element_text(colour = "black", size = 15), 
        panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank()) +
    annotate("text", x = 0, y = 0, size = 8, label = "Dependencies") +
  theme(legend.position = "top",
        text = element_text(size = 16, family = "LM Roman 10"))
    
```

### Plot conflicts

```{r}
results <-
  results %>% 
  filter(Type == "transitive") %>% 
  mutate(UsageType = ifelse(
    UsedDeclared == "true",
    "UsedDeclared",
    ifelse(
      UsedUndeclared == "true",
      "UsedUndeclared",
      ifelse(BloatedDeclared == "true", "BloatedDeclared", "BloatedUndeclared")
    )
  )) 

results %>% filter(UsageType == "UsedUndeclared" | UsageType == "BloatedUndeclared") %>% 
  ggplot(aes(UsageType, ..count..)) + geom_bar(aes(fill = InConflict), position = "dodge") +
   theme(legend.position = "top", text=element_text(size=14, family="LM Roman 10"))

ggsave(filename = "Figures/usage-conflicts.pdf", height = 4, width = 6,  units = c("in"), device = cairo_pdf)

```